<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perp DEX Funding Rates Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .loading {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Perp DEX Funding Rates
                </h1>
                <button onclick="refreshData()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors disabled:opacity-50" id="refreshBtn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Actualiser
                </button>
            </div>
            <p class="text-slate-400">
                Identifiez les opportunit√©s d'arbitrage entre Paradex et Lighter
            </p>
            <p class="text-sm text-slate-500 mt-2" id="lastUpdate">
                Chargement des donn√©es...
            </p>
            <div class="mt-2 flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full" id="apiStatusPDX"></div>
                    <span class="text-xs text-slate-400" id="apiStatusTextPDX">Paradex...</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full" id="apiStatusLTR"></div>
                    <span class="text-xs text-slate-400" id="apiStatusTextLTR">Lighter...</span>
                </div>
            </div>
        </div>

        <!-- API Status Box -->
        <div id="apiErrorBox" class="hidden bg-yellow-900/30 border border-yellow-700 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <div class="text-sm text-yellow-300">
                    <p class="font-semibold mb-1">‚ö†Ô∏è Limitation des APIs</p>
                    <p id="apiErrorMessage"></p>
                    <p class="mt-2 text-yellow-200">üí° <strong>Solution:</strong> Pour un site avec vraies APIs fonctionnelles, il faut cr√©er un backend (Node.js, Python) qui appelle les APIs et √©vite les restrictions CORS.</p>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-6 flex items-start gap-3">
            <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="text-sm text-slate-300">
                <p class="font-semibold mb-1">Comment arbitrer:</p>
                <p>Lorsqu'un spread est important entre Paradex et Lighter, vous pouvez shorter sur la plateforme avec le taux le plus √©lev√© (vous recevez des funding fees) et longer sur celle avec le taux le plus bas (vous payez moins de fees). Le profit vient de la diff√©rence entre les deux taux.</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex gap-4 mb-6 flex-wrap">
            <div>
                <label class="text-sm text-slate-400 mb-2 block">Trier par:</label>
                <select id="sortBy" onchange="renderData()" class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white">
                    <option value="spread">Spread (meilleur en premier)</option>
                    <option value="token">Token (A-Z)</option>
                </select>
            </div>
            <div>
                <label class="text-sm text-slate-400 mb-2 block">Filtrer par token:</label>
                <select id="filterToken" onchange="renderData()" class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white">
                    <option value="all">Tous les tokens</option>
                </select>
            </div>
        </div>

        <!-- Data Container -->
        <div id="dataContainer" class="space-y-4">
            <div class="text-center py-12">
                <div class="loading inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-400 mt-4">Tentative de connexion aux APIs...</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-sm text-slate-500">
            <p>üîÑ Ce site tente de se connecter aux APIs Paradex et Lighter</p>
            <p class="mt-2">Note: Les APIs publiques peuvent bloquer les requ√™tes directes depuis un navigateur (CORS)</p>
        </div>
    </div>

    <script>
        let fundingData = [];
        const dexes = ['Paradex', 'Lighter'];
        let isLoading = false;

        // Fonction pour r√©cup√©rer Paradex
        async function fetchParadexData() {
            try {
                console.log('Tentative de connexion √† Paradex...');
                updateApiStatus('PDX', 'loading', 'Connexion...');
                
                const response = await fetch('https://api.prod.paradex.trade/v1/markets/summary?market=ALL', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es Paradex re√ßues:', data);
                
                const fundingRates = {};
                if (data && data.results && Array.isArray(data.results)) {
                    data.results.forEach(market => {
                        if (market.symbol) {
                            const symbol = market.symbol.replace('-USD-PERP', '');
                            if (market.funding_rate !== undefined) {
                                fundingRates[symbol] = parseFloat(market.funding_rate);
                            }
                        }
                    });
                }
                
                console.log('Funding rates Paradex:', fundingRates);
                updateApiStatus('PDX', 'success', `${Object.keys(fundingRates).length} march√©s`);
                return fundingRates;
            } catch (error) {
                console.error('Erreur Paradex:', error);
                updateApiStatus('PDX', 'error', error.message);
                showApiError('Paradex', error.message);
                return {};
            }
        }

        // Fonction pour r√©cup√©rer Lighter  
        async function fetchLighterData() {
            try {
                console.log('Tentative de connexion √† Lighter...');
                updateApiStatus('LTR', 'loading', 'Connexion...');
                
                // Essayer l'endpoint markets
                const response = await fetch('https://api.lighter.xyz/markets', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es Lighter re√ßues:', data);
                
                const fundingRates = {};
                if (Array.isArray(data)) {
                    data.forEach(market => {
                        if (market.symbol && market.funding_rate !== undefined) {
                            const symbol = market.symbol.split('_')[0].replace('PERP', '');
                            fundingRates[symbol] = parseFloat(market.funding_rate);
                        }
                    });
                }
                
                console.log('Funding rates Lighter:', fundingRates);
                updateApiStatus('LTR', 'success', `${Object.keys(fundingRates).length} march√©s`);
                return fundingRates;
            } catch (error) {
                console.error('Erreur Lighter:', error);
                updateApiStatus('LTR', 'error', error.message);
                showApiError('Lighter', error.message);
                return {};
            }
        }

        function updateApiStatus(api, status, message) {
            const statusId = `apiStatus${api}`;
            const textId = `apiStatusText${api}`;
            const statusDot = document.getElementById(statusId);
            const statusText = document.getElementById(textId);
            
            if (statusDot && statusText) {
                if (status === 'success') {
                    statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                    statusText.textContent = message;
                    statusText.className = 'text-xs text-green-400';
                } else if (status === 'error') {
                    statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                    statusText.textContent = message;
                    statusText.className = 'text-xs text-red-400';
                } else if (status === 'loading') {
                    statusDot.className = 'w-2 h-2 bg-yellow-500 rounded-full animate-pulse';
                    statusText.textContent = message;
                    statusText.className = 'text-xs text-yellow-400';
                }
            }
        }

        function showApiError(dex, error) {
            const errorBox = document.getElementById('apiErrorBox');
            const errorMessage = document.getElementById('apiErrorMessage');
            
            errorBox.classList.remove('hidden');
            
            if (error.includes('CORS') || error.includes('Failed to fetch') || error.includes('NetworkError')) {
                errorMessage.innerHTML = `
                    <strong>${dex}</strong>: Impossible d'acc√©der √† l'API directement depuis le navigateur (restriction CORS).<br>
                    Les APIs ${dex} sont prot√©g√©es et n√©cessitent soit :<br>
                    ‚Ä¢ Un backend interm√©diaire<br>
                    ‚Ä¢ Une cl√© API avec authentification<br>
                    ‚Ä¢ L'utilisation de WebSockets au lieu de REST
                `;
            } else {
                errorMessage.innerHTML = `<strong>${dex}</strong>: ${error}`;
            }
        }

        async function generateRealData() {
            const [pdxRates, ltrRates] = await Promise.all([
                fetchParadexData(),
                fetchLighterData()
            ]);

            // Si aucune API ne fonctionne, affiche des donn√©es de d√©mo
            if (Object.keys(pdxRates).length === 0 && Object.keys(ltrRates).length === 0) {
                console.log('Aucune donn√©e API, affichage de donn√©es de d√©mo');
                return generateDemoData();
            }

            const allTokens = [...new Set([...Object.keys(pdxRates), ...Object.keys(ltrRates)])];
            const data = [];
            
            allTokens.forEach(token => {
                const pdxRate = pdxRates[token];
                const ltrRate = ltrRates[token];
                
                if (pdxRate === undefined && ltrRate === undefined) return;
                
                const rates = {
                    'Paradex': pdxRate !== undefined ? (pdxRate * 100).toFixed(4) : 'N/A',
                    'Lighter': ltrRate !== undefined ? (ltrRate * 100).toFixed(4) : 'N/A'
                };
                
                if (pdxRate !== undefined && ltrRate !== undefined) {
                    const pdxRatePercent = pdxRate * 100;
                    const ltrRatePercent = ltrRate * 100;
                    const spread = Math.abs(pdxRatePercent - ltrRatePercent).toFixed(3);
                    
                    const maxDex = pdxRatePercent > ltrRatePercent ? 'Paradex' : 'Lighter';
                    const minDex = pdxRatePercent > ltrRatePercent ? 'Lighter' : 'Paradex';
                    
                    data.push({
                        token,
                        rates,
                        spread: parseFloat(spread),
                        maxDex,
                        minDex,
                        maxRate: Math.max(pdxRate, ltrRate),
                        minRate: Math.min(pdxRate, ltrRate),
                        hasBothRates: true
                    });
                } else {
                    data.push({
                        token,
                        rates,
                        spread: 0,
                        maxDex: pdxRate !== undefined ? 'Paradex' : 'Lighter',
                        minDex: null,
                        maxRate: pdxRate || ltrRate,
                        minRate: pdxRate || ltrRate,
                        hasBothRates: false
                    });
                }
            });
            
            return data;
        }

        function generateDemoData() {
            const tokens = ['BTC', 'ETH', 'SOL', 'ARB', 'AVAX'];
            const data = [];
            
            tokens.forEach(token => {
                const pdxRate = (Math.random() * 0.1 - 0.05);
                const ltrRate = pdxRate + (Math.random() * 0.02 - 0.01);
                
                const spread = Math.abs((pdxRate - ltrRate) * 100).toFixed(3);
                
                data.push({
                    token,
                    rates: {
                        'Paradex': (pdxRate * 100).toFixed(4),
                        'Lighter': (ltrRate * 100).toFixed(4)
                    },
                    spread: parseFloat(spread),
                    maxDex: pdxRate > ltrRate ? 'Paradex' : 'Lighter',
                    minDex: pdxRate > ltrRate ? 'Lighter' : 'Paradex',
                    maxRate: Math.max(pdxRate, ltrRate),
                    minRate: Math.min(pdxRate, ltrRate),
                    hasBothRates: true,
                    isDemo: true
                });
            });
            
            return data;
        }

        function getSpreadColor(spread) {
            if (spread > 0.15) return 'text-green-600 font-bold';
            if (spread > 0.08) return 'text-yellow-600';
            return 'text-gray-600';
        }

        function getFundingColor(rate) {
            if (rate === 'N/A') return 'bg-gray-200 text-gray-600';
            const rateNum = parseFloat(rate) / 100;
            if (rateNum > 0.05) return 'bg-green-100 text-green-800';
            if (rateNum > 0) return 'bg-green-50 text-green-700';
            if (rateNum > -0.05) return 'bg-red-50 text-red-700';
            return 'bg-red-100 text-red-800';
        }

        async function refreshData() {
            if (isLoading) return;
            
            isLoading = true;
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            
            fundingData = await generateRealData();
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
            
            const filterSelect = document.getElementById('filterToken');
            const currentValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">Tous les tokens</option>';
            
            const tokens = [...new Set(fundingData.map(d => d.token))].sort();
            tokens.forEach(token => {
                filterSelect.innerHTML += `<option value="${token}">${token}</option>`;
            });
            filterSelect.value = currentValue;
            
            renderData();
            
            refreshBtn.disabled = false;
            isLoading = false;
        }

        function renderData() {
            const sortBy = document.getElementById('sortBy').value;
            const filterToken = document.getElementById('filterToken').value;
            
            let sortedData = [...fundingData];
            if (sortBy === 'spread') {
                sortedData.sort((a, b) => b.spread - a.spread);
            } else {
                sortedData.sort((a, b) => a.token.localeCompare(b.token));
            }
            
            const filteredData = filterToken === 'all' 
                ? sortedData 
                : sortedData.filter(d => d.token === filterToken);
            
            const container = document.getElementById('dataContainer');
            container.innerHTML = '';
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-slate-400">Aucune donn√©e disponible</div>';
                return;
            }
            
            const hasDemo = filteredData.some(item => item.isDemo);
            
            if (hasDemo) {
                const demoWarning = document.createElement('div');
                demoWarning.className = 'bg-orange-900/30 border border-orange-700 rounded-lg p-4 mb-4';
                demoWarning.innerHTML = `
                    <div class="flex items-center gap-2 text-orange-300">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span class="font-semibold">Mode D√©mo: Les APIs ne sont pas accessibles, affichage de donn√©es simul√©es</span>
                    </div>
                `;
                container.appendChild(demoWarning);
            }
            
            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-lg border border-slate-700 overflow-hidden fade-in';
                
                const ratesHTML = Object.entries(item.rates).map(([dex, rate]) => {
                    const isNA = rate === 'N/A';
                    const rateNum = isNA ? 0 : parseFloat(rate);
                    const arrow = isNA ? '' : rateNum > 0 
                        ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>'
                        : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>';
                    
                    const badge = item.isDemo ? '<div class="absolute top-1 right-1"><span class="text-xs bg-orange-600 text-white px-1 rounded font-semibold">DEMO</span></div>' 
                                : !isNA ? '<div class="absolute top-1 right-1"><span class="text-xs bg-green-600 text-white px-1 rounded font-semibold">LIVE</span></div>' 
                                : '';
                    
                    return `
                        <div class="p-3 rounded-lg ${getFundingColor(rate)} relative">
                            ${badge}
                            <div class="text-xs font-semibold mb-1">${dex}</div>
                            <div class="flex items-center gap-1">
                                ${arrow}
                                <span class="font-bold">${isNA ? 'N/A' : rateNum.toFixed(3) + '%'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                const opportunityHTML = item.hasBothRates && item.spread > 0.05 ? `
                    <div class="bg-green-900/20 border border-green-700 rounded-lg p-3 flex items-start gap-3 mt-4">
                        <svg class="w-5 h-5 text-green-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="text-sm">
                            <p class="font-semibold text-green-300 mb-1">üî• Opportunit√© d'arbitrage d√©tect√©e!</p>
                            <p class="text-slate-300">
                                <span class="font-semibold text-red-400">Short sur ${item.maxDex}</span> (${(item.maxRate * 100).toFixed(3)}%) et 
                                <span class="font-semibold text-green-400">Long sur ${item.minDex}</span> (${(item.minRate * 100).toFixed(3)}%)
                            </p>
                            <p class="text-slate-400 mt-1">
                                Profit estim√©: ~${item.spread}% par p√©riode de funding
                            </p>
                        </div>
                    </div>
                ` : !item.hasBothRates ? `
                    <div class="bg-yellow-900/20 border border-yellow-700 rounded-lg p-3 mt-4">
                        <p class="text-sm text-yellow-300">‚ö†Ô∏è Token disponible uniquement sur ${item.maxDex}</p>
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <div class="p-4 bg-slate-750 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center font-bold">
                                ${item.token.slice(0, 2)}
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">${item.token}-PERP</h3>
                                <p class="text-sm text-slate-400">Funding rate</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-slate-400 mb-1">Spread d'arbitrage</div>
                            <div class="text-2xl font-bold ${getSpreadColor(item.spread)}">
                                ${item.hasBothRates ? item.spread + '%' : 'N/A'}
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            ${ratesHTML}
                        </div>
                        ${opportunityHTML}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Initialize
        refreshData();
        
        // Auto-refresh every 60 seconds
        setInterval(refreshData, 60000);
    </script>
</body>
</html>